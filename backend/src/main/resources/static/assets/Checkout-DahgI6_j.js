import{d as M,r as k,j as e,L as V,e as H}from"./vendor-CYIUVSsn.js";import{a as v,u as J}from"./index-B7VpOX0o.js";import{W as Y}from"./icons-BxXoZdfl.js";import{c as $,a as K,s as E,b as N}from"./paymentStorage-DeWr5p_q.js";import"./ui-libs-CrvD3He2.js";async function Q(t){const a=await v("/api/payment/order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t||{})}),p=await a.json().catch(()=>({}));return{ok:a.ok&&p.ok!==!1,data:p,status:a.status}}async function F(t){const a=await v("/api/payment/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({razorpay_order_id:t==null?void 0:t.orderId,razorpay_payment_id:t==null?void 0:t.paymentId,razorpay_signature:(t==null?void 0:t.signature)||""})}),p=await a.json().catch(()=>({}));return{ok:a.ok&&p.ok!==!1,data:p,status:a.status}}async function q(){const t=await v("/api/payment/status"),a=await t.json().catch(()=>null);return{ok:t.ok&&!!a,data:a}}const U="/assets/poster-CQH4Ncyo.webp",se=()=>{const t=M(),{user:a}=J(),[p,u]=k.useState([]),[j,c]=k.useState(!1),g=k.useRef(null),P=k.useRef(null),s=k.useRef(!1),b=k.useRef(!1);k.useEffect(()=>{(async()=>{const{ok:l,data:y}=await q();l&&y.unlocked&&t("/dashboard")})()},[t]);const D=()=>new Promise(n=>{const l="razorpay-checkout-js";if(typeof window<"u"&&window.Razorpay)return b.current=!0,n(!0);const y=document.getElementById(l);y&&y.remove();const d=document.createElement("script");d.id=l,d.src="https://checkout.razorpay.com/v1/checkout.js",d.async=!0,d.onload=()=>{b.current=!0,n(!0)},d.onerror=()=>{n(!1)},document.body.appendChild(d)}),O=n=>(n||"").replace(/[^\d]/g,""),B=n=>{const l=O(n);return l?l.length<10?null:l:""},w=async()=>{var z,R,S,_,C,A;if(s.current)return;s.current=!0,c(!0),u([]),$(),K();const n=((R=(z=g.current)==null?void 0:z.value)==null?void 0:R.trim())||"",l=((S=P.current)==null?void 0:S.value)||"",y=B(l);if(y===null){u(["Enter a valid WhatsApp number or leave it blank."]),c(!1),s.current=!1;return}const d=y||"",L=n||(a==null?void 0:a.fullName)||((_=a==null?void 0:a.email)==null?void 0:_.split("@")[0])||"";let I;try{I=await Q({buyerName:n,buyerPhone:d})}catch{u(["Unable to reach the payment server. Please try again."]),c(!1),s.current=!1;return}const{ok:W,data:r}=I;if(!W){u([r.message||"Failed to create payment order"]),c(!1),s.current=!1;return}if(r.mode==="MOCK"){const i=`pay_mock_${Date.now()}`;let o;try{o=await F({orderId:r.orderId,paymentId:i,signature:""})}catch{u(["Payment verification failed. Please try again."]),c(!1),s.current=!1;return}if(o.ok){const m={orderId:r.orderId,paymentId:i,amountPaise:r.amountPaise,googleDriveUrl:(C=o.data)==null?void 0:C.unlockedVideoUrl};E(m,a==null?void 0:a.id),c(!1),s.current=!1,t("/payment-success",{state:m})}else{const h={reason:((A=o.data)==null?void 0:A.message)||"Payment failed. Please try again."};N(h,a==null?void 0:a.id),c(!1),s.current=!1,t("/payment-failed",{state:h})}return}if(!await D()){u(["Failed to load payment gateway. Please try again."]),c(!1),s.current=!1;return}if(!r.keyId||!r.orderId){u(["Payment configuration missing. Please contact support."]),c(!1),s.current=!1;return}const T={key:r.keyId||"rzp_test_S1mk723Rt4DSsp",amount:r.amountPaise,currency:r.currency||"INR",name:"As Dance",description:"Unlock Premium Content",image:U,order_id:r.orderId,handler:async i=>{var m,h;let o;try{o=await F({orderId:i.razorpay_order_id||r.orderId,paymentId:i.razorpay_payment_id,signature:i.razorpay_signature})}catch{const x={reason:"Payment verification failed. Please try again."};N(x,a==null?void 0:a.id),c(!1),s.current=!1,t("/payment-failed",{state:x});return}if(o.ok){const f={orderId:i.razorpay_order_id||r.orderId,paymentId:i.razorpay_payment_id,amountPaise:r.amountPaise,googleDriveUrl:(m=o.data)==null?void 0:m.unlockedVideoUrl};E(f,a==null?void 0:a.id),c(!1),s.current=!1,t("/payment-success",{state:f})}else{const x={reason:((h=o.data)==null?void 0:h.message)||"Payment failed. Please try again."};N(x,a==null?void 0:a.id),c(!1),s.current=!1,t("/payment-failed",{state:x})}},prefill:{name:L,email:(a==null?void 0:a.email)||void 0,contact:d},theme:{color:"#3399cc"},modal:{ondismiss:()=>{c(!1),s.current=!1}}};try{const i=new window.Razorpay(T);i.on("payment.failed",o=>{var f;const h={reason:((f=o==null?void 0:o.error)==null?void 0:f.description)||"Payment failed. Please try again."};N(h,a==null?void 0:a.id),c(!1),s.current=!1,t("/payment-failed",{state:h})}),i.open()}catch{u(["Failed to open payment gateway. Please try again."]),c(!1),s.current=!1}};return e.jsx("section",{className:"checkout-page",children:e.jsxs("div",{className:"checkout-shell container-max",children:[e.jsxs("div",{className:"checkout-top-actions",children:[e.jsx(V,{className:"btn btn-outline-light",to:"/",children:"Home"}),e.jsx("button",{className:"btn btn-outline-light",type:"button",onClick:()=>t(-1),children:"Back"})]}),e.jsxs("div",{className:"checkout-float",children:[e.jsxs("div",{className:"checkout-left",children:[e.jsx("div",{className:"checkout-micro-stats",children:"Secure Checkout"}),e.jsx("div",{className:"checkout-brandline",children:"AS DANCE"}),e.jsx("div",{className:"checkout-title-sm",children:"Unlock the 639-Step Bundle"}),e.jsx("div",{className:"checkout-subtitle",children:"One-time payment. Instant unlock. Lifetime access."}),e.jsxs("div",{className:"checkout-steps",children:[e.jsx("span",{className:"checkout-step is-complete",children:"Details"}),e.jsx("span",{className:"checkout-step-divider",children:"•"}),e.jsx("span",{className:"checkout-step is-active",children:"Payment"}),e.jsx("span",{className:"checkout-step-divider",children:"•"}),e.jsx("span",{className:"checkout-step",children:"Unlock"})]}),e.jsx("p",{className:"checkout-body",children:"Your bundle unlocks 639 curated steps across easy, medium, and hard routines. Fill in optional contact details so we can reach you instantly after payment."}),e.jsxs("form",{onSubmit:n=>{n.preventDefault(),w()},children:[e.jsxs("div",{className:"checkout-field-grid",children:[e.jsxs("div",{className:"checkout-field",children:[e.jsxs("label",{className:"checkout-field-label",htmlFor:"checkout-name",children:["Full Name ",e.jsx("span",{className:"checkout-optional",children:"(optional)"})]}),e.jsx("input",{id:"checkout-name",ref:g,type:"text",className:"checkout-input",placeholder:"Your name",autoComplete:"name"})]}),e.jsxs("div",{className:"checkout-field",children:[e.jsxs("label",{className:"checkout-field-label",htmlFor:"checkout-phone",children:["WhatsApp ",e.jsx("span",{className:"checkout-optional",children:"(optional)"})]}),e.jsx("input",{id:"checkout-phone",ref:P,type:"tel",className:"checkout-input",placeholder:"WhatsApp number",inputMode:"tel",autoComplete:"tel"}),e.jsx("span",{className:"checkout-hint",children:"Enter 10+ digits or leave blank."})]})]}),e.jsx("div",{className:"checkout-actions-row",children:e.jsx("button",{className:"checkout-btn checkout-btn-primary",type:"submit",disabled:j,children:j?"Processing...":"Buy Now"})})]}),j&&e.jsxs("div",{className:"checkout-processing","aria-live":"polite",children:[e.jsx("span",{className:"checkout-spinner","aria-hidden":"true"}),"Payment window is loading..."]}),p.map((n,l)=>e.jsx("div",{className:"checkout-message",role:"alert",children:n},`checkout-msg-${l}`))]}),e.jsx("div",{className:"checkout-right",children:e.jsxs("div",{className:"checkout-summary-card",children:[e.jsx("div",{className:"checkout-label",children:"Order Summary"}),e.jsx("div",{className:"bundle-preview",children:e.jsx("img",{src:U,alt:"Bundle Preview",loading:"lazy",decoding:"async",width:"640",height:"360"})}),e.jsxs("div",{className:"checkout-summary-row",children:[e.jsx("span",{children:"Bundle Access"}),e.jsx("span",{className:"checkout-summary-value",children:"₹499"})]}),e.jsxs("div",{className:"checkout-summary-row total",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{className:"checkout-summary-value",children:"₹499"})]}),e.jsx("button",{className:"checkout-summary-cta",type:"button",onClick:w,disabled:j,children:j?"Processing...":"Pay ₹499"}),e.jsx("div",{className:"checkout-trust-divider"}),e.jsxs("div",{className:"checkout-trust-row",children:[e.jsx("span",{className:"checkout-trust-item",children:"Secure Payment"}),e.jsx("span",{className:"checkout-trust-item",children:"Instant Unlock"}),e.jsx("span",{className:"checkout-trust-item",children:"Lifetime Access"})]}),e.jsx("div",{className:"checkout-receipt",children:"Receipt delivered instantly after payment."}),e.jsxs("div",{className:"checkout-support",children:[e.jsxs("div",{className:"checkout-support-item",children:[e.jsx(Y,{size:18,className:"support-icon","aria-hidden":"true"}),e.jsxs("div",{children:[e.jsx("div",{className:"support-label",children:"WhatsApp Support"}),e.jsx("div",{className:"support-value",children:"+91 88256 02356"})]})]}),e.jsxs("div",{className:"checkout-support-item",children:[e.jsx(H,{size:18,className:"support-icon","aria-hidden":"true"}),e.jsxs("div",{children:[e.jsx("div",{className:"support-label",children:"Email"}),e.jsx("div",{className:"support-value",children:e.jsx("a",{href:"mailto:bussinessaswin@gmail.com","aria-label":"Email support",children:"bussinessaswin@gmail.com"})})]})]})]}),e.jsx("div",{className:"checkout-trust-note",children:"Complete payment to unlock your dashboard."})]})})]})]})})};export{se as default};
